---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import Hero from "../components/Hero.astro";

const allEvents = await getCollection("events");

// Send only needed data to the client to keep DOM smaller
const clientEvents = allEvents.map((e) => ({
  dateStr: e.data.date.toISOString().split("T")[0],
  slug: e.slug,
  title: e.data.title,
  time: e.data.time.split("-")[0].trim(),
}));

const base = import.meta.env.BASE_URL;
---

<Layout title="Calendar">
  <Hero activePage="calendar" />

  <div id="calendar-view" class="calendar-wrapper">
    <div class="month-nav-header text-center">
      <h2
        id="current-month-label"
        class="subtitle"
        style="margin-bottom: 1rem;"
      >
        Loading Calendar...
      </h2>
    </div>
    <div class="month-nav">
      <button id="prev-month" class="btn glass-panel nav-btn"
        >&larr; Previous</button
      >
      <button id="next-month" class="btn glass-panel nav-btn"
        >Next &rarr;</button
      >
    </div>

    <div class="calendar-container glass-panel">
      <div
        class="calendar-grid"
        id="calendar-grid"
        data-events={JSON.stringify(clientEvents)}
        data-base={base}
      >
        <!-- Calendar headers and days injected via client script -->
        <div class="weekday">Sun</div>
        <div class="weekday">Mon</div>
        <div class="weekday">Tue</div>
        <div class="weekday">Wed</div>
        <div class="weekday">Thu</div>
        <div class="weekday">Fri</div>
        <div class="weekday">Sat</div>
      </div>
    </div>
  </div>
</Layout>

<script>
  const monthNames = [
    "January",
    "February",
    "March",
    "April",
    "May",
    "June",
    "July",
    "August",
    "September",
    "October",
    "November",
    "December",
  ];

  let currentDate = new Date(); // Start at today

  const gridEl = document.getElementById("calendar-grid") as HTMLElement;
  const labelEl = document.getElementById("current-month-label");
  const prevBtn = document.getElementById("prev-month");
  const nextBtn = document.getElementById("next-month");

  // Parse events data passed from server
  const allEvents: any[] = JSON.parse(gridEl.dataset.events || "[]");
  const baseUrl = gridEl.dataset.base;

  // Group events by date string
  const eventsByDate = allEvents.reduce((acc: any, event: any) => {
    if (!acc[event.dateStr]) acc[event.dateStr] = [];
    acc[event.dateStr].push(event);
    return acc;
  }, {});

  function renderCalendar() {
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();
    const todayStr = new Date().toISOString().split("T")[0];

    // Update label
    if (labelEl) {
      labelEl.textContent = `See what's happening in ${monthNames[currentMonth]} ${currentYear}`;
    }

    // Get calendar math
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();

    // Preserve weekday headers
    const weekdayHeaders = `
      <div class="weekday">Sun</div>
      <div class="weekday">Mon</div>
      <div class="weekday">Tue</div>
      <div class="weekday">Wed</div>
      <div class="weekday">Thu</div>
      <div class="weekday">Fri</div>
      <div class="weekday">Sat</div>
    `;

    let cellsHtml = "";

    // Pad start of month
    for (let i = 0; i < firstDayOfMonth; i++) {
      cellsHtml += `<div class="calendar-cell empty"></div>`;
    }

    // Actual days
    for (let i = 1; i <= daysInMonth; i++) {
      // Build YYYY-MM-DD string with padded 0s
      const m = String(currentMonth + 1).padStart(2, "0");
      const d = String(i).padStart(2, "0");
      const dateStr = `${currentYear}-${m}-${d}`;

      const isToday = dateStr === todayStr;
      const dayEvents = eventsByDate[dateStr] || [];
      const hasEvents = dayEvents.length > 0;

      let eventsHtml = "";
      dayEvents.forEach((e: any) => {
        eventsHtml += `
              <a href="${baseUrl}/events/${e.slug}" class="event-pill" title="${e.title.replace(/"/g, "&quot;")}">
                <span class="pill-time">${e.time}</span>
                <span class="pill-title">${e.title}</span>
              </a>
            `;
      });

      cellsHtml += `
          <div class="calendar-cell ${isToday ? "today" : ""} ${hasEvents ? "has-events" : ""}">
             <div class="cell-header">
               <span class="day-number">${i}</span>
             </div>
             <div class="cell-events">
                 ${eventsHtml}
             </div>
          </div>
        `;
    }

    gridEl.innerHTML = weekdayHeaders + cellsHtml;
  }

  // Event listeners
  if (prevBtn) {
    prevBtn.addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    });
  }

  if (nextBtn) {
    nextBtn.addEventListener("click", () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    });
  }

  // Initial render
  if (gridEl) {
    renderCalendar();
  }
</script>

<style is:global>
  /* CALENDAR VIEW STYLES */
  .calendar-wrapper {
    max-width: 1200px;
    margin: 0 auto 4rem auto;
    scroll-margin-top: 5rem;
  }

  .month-nav {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding: 0 1rem;
  }

  .nav-btn {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    color: var(--text-primary);
  }

  .calendar-container {
    padding: 1.5rem;
    overflow-x: auto;
  }

  .calendar-container.glass-panel:hover {
    transform: none;
    box-shadow: var(--glass-shadow);
    background: var(--bg-surface);
    border: var(--glass-border);
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, minmax(120px, 1fr));
    gap: 1px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    overflow: hidden;
  }

  .weekday {
    background: rgba(0, 0, 0, 0.5);
    padding: 1rem;
    text-align: center;
    font-weight: 600;
    color: var(--accent-secondary);
    text-transform: uppercase;
    font-size: 0.9rem;
    letter-spacing: 1px;
  }

  .calendar-cell {
    background: var(--bg-surface);
    min-height: 120px;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    transition: background 0.2s;
  }

  .calendar-cell:hover:not(.empty) {
    background: var(--bg-surface-hover);
  }

  .calendar-cell.empty {
    background: rgba(0, 0, 0, 0.2);
  }

  .cell-header {
    text-align: right;
    margin-bottom: 0.5rem;
  }

  .day-number {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-secondary);
  }

  .calendar-cell.today .day-number {
    background: var(--accent-gradient);
    color: #000;
    box-shadow: 0 0 10px rgba(255, 126, 0, 0.5);
  }

  .calendar-cell.has-events .day-number {
    color: var(--text-primary);
  }

  .cell-events {
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex: 1;
  }

  .event-pill {
    display: flex;
    align-items: center;
    background: rgba(255, 126, 0, 0.15);
    border-left: 3px solid var(--accent-primary);
    padding: 4px 6px;
    border-radius: 4px;
    font-size: 0.75rem;
    text-decoration: none;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition:
      transform 0.2s,
      background 0.2s;
  }

  .event-pill:hover {
    background: rgba(255, 126, 0, 0.3);
    transform: translateX(2px);
    text-shadow: none;
    color: #fff;
  }

  .pill-time {
    font-weight: 700;
    color: var(--accent-secondary);
    margin-right: 6px;
  }

  .pill-title {
    overflow: hidden;
    text-overflow: ellipsis;
  }
</style>
